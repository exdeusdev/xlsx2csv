
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>xlsx2csv</title>
</head>
<body>
<script
  crossorigin
  src="https://unpkg.com/react/umd/react.production.min.js"
></script>
<script
  crossorigin
  src="https://unpkg.com/react-dom/umd/react-dom.production.min.js"
></script>
<script
  crossorigin
  src="https://unpkg.com/@babel/standalone/babel.min.js"
></script>
<script
  crossorigin
  src="https://unpkg.com/antd/dist/antd.min.js"
></script>
<script
  crossorigin
  src="https://unpkg.com/@ailnaf/xlsx2csv/xlsx2csv.min.js"
></script>
<link href="https://unpkg.com/antd/dist/antd.min.css" rel="stylesheet" />

<div id="root"></div>

<script type="text/babel" data-type="module">
    const { useState } = React
    const { Table, Upload, Button, message } = antd

    function App() {

      const [ list, setList ] = useState([])
      const [ columns, setColumns ] = useState([])
      const [uploading, setUploading] = useState(false)

      const readFile = (file) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader()

            reader.onload = (e) => {
                resolve(e.target.result)
            }

            reader.onerror = reject

            reader.readAsArrayBuffer(file)
        })
      }

      const handleFile = async (file) => {
          setUploading(true)
          let data = []
          let columnData = []

          try {
          const buffer = await readFile(file)
          let header
          await xlsx2csv(buffer, row => {
              if (header) {
                const item = header.reduce((m, d, i) => ({...m, [d]: row[i]}), {})
                data.push({...item, key: data.length})
              } else {
                  header = row
                  columnData = header.map(d => ({key: d, dataIndex: d, title: d, ellipsis: true}))
              }
          })
          } catch (e) {
            console.error(e)
            message.error('invalid xlsx file')
          }
          console.log({columnData, data})
          setColumns(columnData)
          setList(data)
          setUploading(false)
      }

      const uploadProps = {
        beforeUpload: (file) => {
            handleFile(file)
            return false
        },
        maxCount: 1,
        accept: '.xlsx',
      }

      return (
        <div className="App">
          <Upload {...uploadProps}>
            <Button loading={uploading}>Upload xlsx</Button>
          </Upload>
          <Table dataSource={list} columns={columns} />
        </div>
      )
    }

    ReactDOM.render(<App />, document.getElementById('root'))
</script>
</body>
</html>
